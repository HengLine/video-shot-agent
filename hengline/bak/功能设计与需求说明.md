# å‰§æœ¬åˆ†é•œæ™ºèƒ½ä½“

å‰§æœ¬åˆ†é•œæ™ºèƒ½ä½“å·¥å…·ï¼ˆScript-to-Shot AI Agentï¼‰

## æ ¸å¿ƒç›®æ ‡

- å°†ä»»æ„é•¿åº¦å‰§æœ¬ â†’ æ‹†åˆ†ä¸º 5ç§’/æ®µ çš„çŸ­è§†é¢‘è„šæœ¬å•å…ƒï¼ˆShotï¼‰
- æ¯æ®µåŒ…å«ï¼šç”»é¢æè¿° + è§’è‰²åŠ¨ä½œ + å¯¹è¯ï¼ˆå¦‚æœ‰ï¼‰+ é•œå¤´è¯­è¨€
- ä¿è¯è·¨ç‰‡æ®µè¿ç»­æ€§ï¼ˆè§’è‰²å¤–è§‚ã€ä½ç½®ã€æƒ…ç»ªã€åŠ¨ä½œçŠ¶æ€ä¸€è‡´ï¼‰
- è¾“å‡ºæ ¼å¼å…¼å®¹ä¸»æµ AI è§†é¢‘ç”Ÿæˆå¹³å°ï¼ˆæ–‡æœ¬æç¤ºè¯æ ¼å¼ï¼‰



## ä½¿ç”¨æ–¹å¼

è¯¥å·¥å…·çš„ä½œç”¨ä¸ºï¼Œå¯ä»¥åµŒå…¥åˆ°å…¶ä»–é¡¹ç›®ä¸­ã€‚

å¯¹å¤–åªæš´éœ²ä¸€ä¸ªç»Ÿä¸€æ¥å£ï¼ˆå‡½æ•°æˆ– APIï¼‰ï¼Œæ”¯æŒçº¯ä¸­æ–‡æ–‡æœ¬å‰§æœ¬ï¼Œæˆ–è€…JSONã€‚æ¯æ¬¡è°ƒç”¨ç‹¬ç«‹ï¼Œä¸ä¾èµ–å¤–éƒ¨ä¼šè¯ã€‚

### å¯¹å¤–æ¥å£å®šä¹‰

```python
from typing import Optional, Dict, Any

def generate_storyboard(
    script_text: str,
    style: str = "realistic",
    duration_per_shot: int = 5,
    prev_continuity_state: Optional[Dict[str, Any]] = None
) -> Dict[str, Any]:
    """
    å‰§æœ¬åˆ†é•œç”Ÿæˆä¸»æ¥å£ï¼ˆå¯åµŒå…¥ LangGraph æˆ– A2A è°ƒç”¨ï¼‰
    
    Args:
        script_text: ç”¨æˆ·è¾“å…¥çš„ä¸­æ–‡å‰§æœ¬ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰
        style: è§†é¢‘é£æ ¼ï¼ˆrealistic / anime / cinematicï¼‰
        duration_per_shot: æ¯æ®µç›®æ ‡æ—¶é•¿ï¼ˆç§’ï¼‰
        prev_continuity_state: ä¸Šä¸€æ®µçš„ continuity_anchorï¼ˆç”¨äºé•¿å‰§æœ¬ç»­ç”Ÿæˆï¼‰
    
    Returns:
        {
            "shots": [  # åˆ†é•œåˆ—è¡¨
                {
                    "shot_id": 1,
                    "chinese_description": "ææ˜ååœ¨å’–å•¡é¦†...",
                    "ai_prompt": "A man in a cafe...",
                    "continuity_anchor": { ... }
                },
                ...
            ],
            "final_continuity_state": { ... },  # ä¾›ä¸‹ä¸€æ®µä½¿ç”¨
            "total_duration": 20
        }
    """
    # å†…éƒ¨è°ƒç”¨å¤šæ™ºèƒ½ä½“åä½œæµç¨‹
    return _run_multi_agent_pipeline(
        script_text,
        style,
        duration_per_shot,
        prev_continuity_state
    )
```

æœ‰ä»¥ä¸‹ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼š

### é›†æˆæ–¹å¼ 1ï¼š

ä½œä¸º LangGraph æ™ºèƒ½ä½“èŠ‚ç‚¹

```python
from langgraph.graph import StateGraph, END

# å®šä¹‰å…¨å±€çŠ¶æ€
class StoryboardState(TypedDict):
    raw_script: str
    style: str
    storyboard: list
    continuity_state: dict
    error: Optional[str]

# åˆ†é•œç”ŸæˆèŠ‚ç‚¹
def storyboard_agent_node(state: StoryboardState) -> dict:
    try:
        result = generate_storyboard(
            script_text=state["raw_script"],
            style=state["style"],
            prev_continuity_state=state.get("continuity_state")
        )
        return {
            "storyboard": result["shots"],
            "continuity_state": result["final_continuity_state"]
        }
    except Exception as e:
        return {"error": str(e)}

# æ„å»ºå›¾
workflow = StateGraph(StoryboardState)
workflow.add_node("generate_storyboard", storyboard_agent_node)
workflow.set_entry_point("generate_storyboard")
workflow.add_edge("generate_storyboard", END)

app = workflow.compile()
```



### é›†æˆæ–¹å¼ 2ï¼š

é€šè¿‡ A2A åè®®è°ƒç”¨ï¼ˆHTTP / gRPCï¼‰

```java
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI(title="Storyboard Agent Service")

class StoryboardRequest(BaseModel):
    script_text: str
    style: str = "realistic"
    duration_per_shot: int = 5
    prev_continuity_state: dict = None

class StoryboardResponse(BaseModel):
    shots: list
    final_continuity_state: dict
    total_duration: float

@app.post("/a2a/generate_storyboard", response_model=StoryboardResponse)
async def a2a_storyboard(request: StoryboardRequest):
    result = generate_storyboard(
        script_text=request.script_text,
        style=request.style,
        duration_per_shot=request.duration_per_shot,
        prev_continuity_state=request.prev_continuity_state
    )
    return result
```




â€‹	

## æ™ºèƒ½ä½“æ¶æ„

**æ™ºèƒ½ä½“æ¡†æ¶**:LangGraphï¼ˆä¸“ä¸ºå¤šæ™ºèƒ½ä½“çŠ¶æ€æœºè®¾è®¡ï¼‰

| æ™ºèƒ½ä½“åç§°                                       | èŒè´£                                                         | æŠ€æœ¯æ ˆ                           | è¾“å…¥ â†’ è¾“å‡º                        |
| ------------------------------------------------ | ------------------------------------------------------------ | -------------------------------- | ---------------------------------- |
| 1. å‰§æœ¬è§£ææ™ºèƒ½ä½“ï¼ˆScript Parser Agentï¼‰         | è§£æåŸå§‹å‰§æœ¬ï¼Œæå–ç»“æ„åŒ–å…ƒç´ ï¼ˆåœºæ™¯ã€è§’è‰²ã€åŠ¨ä½œã€å¯¹è¯ã€æƒ…ç»ªï¼‰ | LlamaIndex + è§„åˆ™å¼•æ“            | åŸå§‹æ–‡æœ¬ â†’ ç»“æ„åŒ–å‰§æœ¬å¯¹è±¡ï¼ˆJSONï¼‰  |
| 2. æ—¶åºè§„åˆ’æ™ºèƒ½ä½“ï¼ˆTemporal Planner Agentï¼‰      | å°†å‰§æœ¬æŒ‰ 5 ç§’ç²’åº¦åˆ‡åˆ†ï¼Œä¼°ç®—æ¯æ®µåŠ¨ä½œ/å¯¹è¯æ—¶é•¿ï¼Œé¿å…è¶…æ—¶       | è§„åˆ™åº“ + LLMï¼ˆå¾®è°ƒåŠ¨ä½œæ—¶é•¿æ¨¡å‹ï¼‰ | ç»“æ„åŒ–å‰§æœ¬ â†’ å¸¦æ—¶é—´æˆ³çš„åˆ†æ®µè®¡åˆ’    |
| 3. è¿ç»­æ€§å®ˆæŠ¤æ™ºèƒ½ä½“ï¼ˆContinuity Guardian Agentï¼‰ | è·Ÿè¸ªè§’è‰²çŠ¶æ€ï¼ˆä½ç½®ã€å§¿åŠ¿ã€æƒ…ç»ªã€é“å…·ï¼‰ï¼Œç”Ÿæˆ/éªŒè¯è¿ç»­æ€§é”šç‚¹  | å‘é‡è®°å¿† + çŠ¶æ€æœº                | ä¸Šä¸€æ®µçŠ¶æ€ + å½“å‰åŠ¨ä½œ â†’ è¿ç»­æ€§çº¦æŸ |
| 4. åˆ†é•œç”Ÿæˆæ™ºèƒ½ä½“ï¼ˆShot Generator Agentï¼‰        | ç”Ÿæˆç¬¦åˆ AI è§†é¢‘æ¨¡å‹è¦æ±‚çš„æç¤ºè¯ï¼ˆå«é•œå¤´ã€å…‰çº¿ã€æ„å›¾ï¼‰       | LangChain + LLMï¼ˆGPT-4o/Claudeï¼‰ | åˆ†æ®µå†…å®¹ + è¿ç»­æ€§é”šç‚¹ â†’ AI Prompt  |
| 5. è´¨é‡å®¡æŸ¥æ™ºèƒ½ä½“ï¼ˆQA Agentï¼‰                    | æ£€æŸ¥åˆ†é•œæ˜¯å¦è¿è´¯ã€æ˜¯å¦è¶…æ—¶ã€è§’è‰²æ˜¯å¦æ¼‚ç§»                     | è§„åˆ™æ£€æŸ¥ + LLM è‡ªåæ€            | åˆ†é•œåºåˆ— â†’ ä¿®æ­£å»ºè®®æˆ–é€šè¿‡          |

**æ™ºèƒ½ä½“åä½œæµç¨‹å›¾**ï¼š

```
graph TD
    A[ç”¨æˆ·è¾“å…¥å‰§æœ¬] --> B(å‰§æœ¬è§£ææ™ºèƒ½ä½“)
    B -->|ç»“æ„åŒ–å‰§æœ¬| C(æ—¶åºè§„åˆ’æ™ºèƒ½ä½“)
    C -->|åˆ†æ®µè®¡åˆ’| D{å¾ªç¯æ¯ä¸€æ®µ}
    D --> E(è¿ç»­æ€§å®ˆæŠ¤æ™ºèƒ½ä½“)
    E -->|è¿ç»­æ€§é”šç‚¹| F(åˆ†é•œç”Ÿæˆæ™ºèƒ½ä½“)
    F -->|AI Prompt + æ–°çŠ¶æ€| G(è´¨é‡å®¡æŸ¥æ™ºèƒ½ä½“)
    G -->|é€šè¿‡?| H{ä¸‹ä¸€æ®µ}
    G -->|å¤±è´¥| I[ä¿®æ­£å¹¶é‡è¯•]
    H -->|æ˜¯| D
    H -->|å¦| J[è¾“å‡ºå®Œæ•´åˆ†é•œåºåˆ—]
```

**æ™ºèƒ½ä½“æ¶ˆæ¯æ ¼å¼**ï¼ˆæ ‡å‡†åŒ–ï¼‰

```json
{
  "agent": "continuity_guardian",
  "segment_id": 3,
  "input": { ... },
  "output": {
    "continuity_constraints": {
      "character": "ææ˜",
      "must_start_with": "æ‰‹æœºåˆšæ¥ä½ï¼Œæ‰‹å¾®æŠ–",
      "camera_angle": "same as previous shot"
    }
  },
  "status": "success"
}
```

**é”™è¯¯å¤„ç†ä¸é‡è¯•**

- QA Agent å‘ç°ä¸è¿è´¯ â†’ è§¦å‘ **å±€éƒ¨é‡ç”Ÿæˆ**ï¼ˆä»…é‡è·‘ Shot 3ï¼‰
- æœ€å¤§é‡è¯•æ¬¡æ•° = 2ï¼Œå¦åˆ™å‘Šè­¦äººå·¥ä»‹å…¥



**æ™ºèƒ½ä½“èŒè´£è¯¦è§£**

1. **Script Parser Agentï¼ˆå‰§æœ¬è§£ææ™ºèƒ½ä½“ï¼‰**

- **èŒè´£**ï¼šå°†æ•´æ®µä¸­æ–‡å‰§æœ¬ â†’ ç»“æ„åŒ–åŠ¨ä½œåºåˆ—

- **è¾“å…¥**ï¼š`"ææ˜ååœ¨å’–å•¡é¦†..."`ï¼ˆå­—ç¬¦ä¸²ï¼‰

- **è¾“å‡º**ï¼š

  ```python
  {
    "scenes": [{
      "location": "åŸå¸‚å’–å•¡é¦†",
      "time": "ä¸‹åˆ3ç‚¹",
      "actions": [
        {"character": "ææ˜", "action": "ååœ¨é çª—ä½ç½®", "emotion": "å¹³é™"},
        {"character": "ææ˜", "dialogue": "ä½ ...ä½ æ€ä¹ˆåœ¨è¿™ï¼Ÿ", "emotion": "ç´§å¼ "}
      ]
    }]
  }
  ```

- æŠ€æœ¯ï¼š

  - LlamaIndex + è§„åˆ™å¢å¼ºçš„ LLMï¼ˆGPT-4oï¼‰
  - ä¸­æ–‡åˆ†è¯ï¼ˆjiebaï¼‰+ æ­£åˆ™åŒ¹é…

- å…³é”®èƒ½åŠ›ï¼š

  - è‡ªåŠ¨è¯†åˆ«åœºæ™¯ã€è§’è‰²ã€åŠ¨ä½œã€å¯¹è¯ã€æƒ…ç»ª
  - æ¨æ–­è§’è‰²å¤–è§‚ï¼ˆè‹¥æœªæä¾›ï¼‰

2. **Temporal Planner Agentï¼ˆæ—¶åºè§„åˆ’æ™ºèƒ½ä½“ï¼‰**

- **èŒè´£**ï¼šå°†åŠ¨ä½œåºåˆ—åˆ‡åˆ†ä¸º 5 ç§’ç‰‡æ®µ
- **è¾“å…¥**ï¼šç»“æ„åŒ–åŠ¨ä½œåˆ—è¡¨
- **è¾“å‡º**ï¼šåˆ†æ®µè®¡åˆ’ï¼ˆæ¯æ®µå«åŠ¨ä½œå­é›† + ä¼°ç®—æ—¶é•¿ï¼‰
- æŠ€æœ¯ï¼š
  - **åŠ¨ä½œæ—¶é•¿ä¼°ç®—å™¨**ï¼ˆåŸºäºåŠ¨è¯åº“ + å¯¹è¯å­—æ•°æ¨¡å‹ï¼‰
  - è´ªå¿ƒç®—æ³•ï¼šç´¯è®¡æ—¶é•¿ â‰¤ 5.5 ç§’ï¼ˆç•™ 0.5 ç§’ç¼“å†²ï¼‰
- å…³é”®è§„åˆ™ï¼š
  - å¯¹è¯ä¸æ‹†åˆ†ï¼ˆä¸€å¥å®Œæ•´å°è¯ï¼‰
  - è¿ç»­åŠ¨ä½œå°½é‡åŒæ®µï¼ˆå¦‚â€œèµ·èº«â†’èµ°å‘é—¨å£â€ï¼‰

3. **Continuity Guardian Agentï¼ˆè¿ç»­æ€§å®ˆæŠ¤æ™ºèƒ½ä½“ï¼‰**

- **èŒè´£**ï¼šç¡®ä¿è§’è‰²çŠ¶æ€è·¨ç‰‡æ®µè¿è´¯

- è¾“å…¥ï¼š

  - ä¸Šä¸€æ®µ `continuity_anchor`
  - å½“å‰åŠ¨ä½œæè¿°

- **è¾“å‡º**ï¼šæœ¬æ®µåˆå§‹çŠ¶æ€çº¦æŸ + æ–° `continuity_anchor`

- **çŠ¶æ€å­—æ®µ**ï¼š

  ```python
  {
    "character_name": "ææ˜",
    "pose": "sitting",
    "position": "é çª—æ¡Œå­",
    "gaze_direction": "downward",
    "holding": "smartphone",
    "emotion": "calm"
  }
  ```

- å…³é”®æŠ€æœ¯ï¼š

  - çŠ¶æ€æœºï¼ˆState Machineï¼‰è·Ÿè¸ªè§’è‰²
  - å‘é‡ç›¸ä¼¼åº¦æ¯”å¯¹ï¼ˆé˜²å¤–è§‚æ¼‚ç§»ï¼‰
    - æ¯æ®µç”Ÿæˆåï¼Œ`continuity_anchor` å­˜å…¥é»‘æ¿ï¼ˆBlackboardï¼‰
    - ä¸‹ä¸€æ®µä»é»‘æ¿è¯»å– `initial_state`

4. **Shot Generator Agentï¼ˆåˆ†é•œç”Ÿæˆæ™ºèƒ½ä½“ï¼‰**

- **èŒè´£**ï¼šç”Ÿæˆæœ€ç»ˆåˆ†é•œï¼ˆå« AI Promptï¼‰

- è¾“å…¥ï¼š

  - åˆ†æ®µåŠ¨ä½œ
  - è¿ç»­æ€§çº¦æŸ
  - è§†é¢‘é£æ ¼ï¼ˆrealistic/animeï¼‰

- **è¾“å‡º**ï¼š

  ```python
  {
    "chinese_description": "ææ˜çŒ›ç„¶æŠ¬å¤´...",
    "ai_video_prompt": "A man suddenly looks up in shock...",
    "camera": {"shot_type": "medium close-up", ...},
    "continuity_anchor": { ... }
  }
  ```

- æŠ€æœ¯ï¼š

  - LangChain + GPT-4oï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰
  - æç¤ºè¯æ¨¡æ¿ï¼ˆå«é•œå¤´è¯­è¨€çŸ¥è¯†åº“ï¼‰

5. **QA Agentï¼ˆè´¨é‡å®¡æŸ¥æ™ºèƒ½ä½“ï¼‰**

- **èŒè´£**ï¼šéªŒè¯åˆ†é•œè´¨é‡
- æ£€æŸ¥é¡¹ï¼š
  - è§’è‰²å¤–è§‚æ˜¯å¦æ¼‚ç§»ï¼ˆå¯¹æ¯” appearanceï¼‰
  - åŠ¨ä½œæ˜¯å¦è¶…æ—¶ï¼ˆ>5.5 ç§’ï¼‰
  - è¿ç»­æ€§æ˜¯å¦æ–­è£‚ï¼ˆä½ç½®çªå˜ï¼‰
  - AI Prompt æ˜¯å¦å«ç¦ç”¨è¯
- è¾“å‡ºï¼š
  - `pass: true` â†’ è¿›å…¥ä¸‹ä¸€æ®µ
  - `pass: false` â†’ è§¦å‘å±€éƒ¨é‡è¯•ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰





## å¤„ç†æµç¨‹



è¯¦ç»†å¤„ç†æµç¨‹ï¼ˆç«¯åˆ°ç«¯ï¼‰

### Step 1ï¼šæ¥æ”¶è¾“å…¥

- è¾“å…¥ï¼šçº¯ä¸­æ–‡è‡ªç„¶è¯­è¨€å‰§æœ¬ï¼ˆ`script_text: str`ï¼‰

- å¯é€‰å‚æ•°ï¼š`style`, `duration_per_shot`, `prev_continuity_state`

  ```python
  åœºæ™¯ï¼šåŸå¸‚å’–å•¡é¦†ï¼Œä¸‹åˆ3ç‚¹ï¼Œé˜³å…‰å¾ˆå¥½ã€‚
  ææ˜ååœ¨é çª—çš„ä½ç½®ï¼Œä½å¤´çœ‹æ‰‹æœºã€‚çªç„¶ï¼Œä»–æŠ¬å¤´çœ‹è§å‰å¥³å‹å°é›¨èµ°è¿›æ¥ï¼Œæ„£ä½äº†ï¼Œæ‰‹æœºå·®ç‚¹æ‰åˆ°åœ°ä¸Šã€‚
  å°é›¨ä¹Ÿçœ‹è§äº†ä»–ï¼ŒçŠ¹è±«äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯èµ°äº†è¿‡æ¥ã€‚
  å°é›¨ï¼ˆè½»å£°ï¼‰ï¼šå¥½ä¹…ä¸è§ã€‚
  ææ˜ï¼ˆç´§å¼ ï¼‰ï¼šä½ â€¦â€¦ä½ æ€ä¹ˆåœ¨è¿™ï¼Ÿ
  ```

  

### Step 2ï¼šå‰§æœ¬è§£æï¼ˆScript Parser Agentï¼‰

- ä½¿ç”¨ LlamaIndex + è§„åˆ™å¼•æ“è§£ææ–‡æœ¬

- è¾“å‡ºç»“æ„åŒ–å‰§æœ¬å¯¹è±¡ï¼š

  ```python
  {
    "scenes": [
      {
        "location": "åŸå¸‚å’–å•¡é¦†å†…",
        "time": "ä¸‹åˆ3ç‚¹",
        "atmosphere": "é˜³å…‰é€è¿‡çª—æˆ·",
        "actions": [
          {"character": "ææ˜", "action": "ååœ¨é çª—ä½ç½®", "emotion": "å¹³é™"},
          {"character": "ææ˜", "action": "æŠ¬å¤´çœ‹è§å°é›¨", "emotion": "éœ‡æƒŠ"},
          {"character": "å°é›¨", "dialogue": "å¥½ä¹…ä¸è§ã€‚", "emotion": "è½»å£°"}
        ]
      }
    ]
  }
  ```

### Step 3ï¼šæ—¶åºè§„åˆ’ï¼ˆTemporal Planner Agentï¼‰

- å°†åŠ¨ä½œåºåˆ—æŒ‰ **5 ç§’ç²’åº¦**åˆ‡åˆ†

- ä¼°ç®—æ¯æ®µåŠ¨ä½œæ—¶é•¿ï¼ˆåŸºäºåŠ¨ä½œåŠ¨è¯åº“ï¼‰

- è¾“å‡ºåˆ†æ®µè®¡åˆ’ï¼š

  ```python
  segments = [
    {"id": 1, "actions": [action1], "est_duration": 4.8},
    {"id": 2, "actions": [action2, action3], "est_duration": 5.1},
    ...
  ]
  ```

### Step 4ï¼šé€æ®µç”Ÿæˆåˆ†é•œï¼ˆå¾ªç¯ï¼‰

å¯¹æ¯ä¸ª `segment` æ‰§è¡Œï¼š

#### 4.1 è¿ç»­æ€§å®ˆæŠ¤ï¼ˆContinuity Guardian Agentï¼‰

- è¾“å…¥ï¼š`prev_continuity_state`ï¼ˆæ¥è‡ªä¸Šä¸€æ®µæˆ–ç”¨æˆ·ï¼‰
- è¾“å‡ºï¼šæœ¬æ®µèµ·å§‹çŠ¶æ€çº¦æŸï¼ˆ`initial_constraints`ï¼‰

#### 4.2 åˆ†é•œç”Ÿæˆï¼ˆShot Generator Agentï¼‰

- è°ƒç”¨ LLMï¼ˆå¦‚ GPT-4oï¼‰ç”Ÿæˆï¼š
  - ä¸­æ–‡ç”»é¢æè¿°ï¼ˆä¾›äººè¯»ï¼‰
  - è‹±æ–‡ AI è§†é¢‘æç¤ºè¯ï¼ˆä¾›æ¨¡å‹ç”¨ï¼‰
  - é•œå¤´è¯­è¨€ã€è§’è‰²çŠ¶æ€
- è¾“å‡ºå•æ®µåˆ†é•œå¯¹è±¡

#### 4.3 çŠ¶æ€æ›´æ–°

- æå–æœ¬æ®µç»“æŸçŠ¶æ€ â†’ ä½œä¸ºä¸‹ä¸€æ®µçš„ `prev_continuity_state`

### Step 5ï¼šè´¨é‡å®¡æŸ¥ï¼ˆQA Agentï¼‰

- æ£€æŸ¥ï¼š
  - è§’è‰²æ˜¯å¦æ¼‚ç§»ï¼ˆappearance ä¸ä¸€è‡´ï¼‰
  - åŠ¨ä½œæ˜¯å¦è¶…æ—¶ï¼ˆ>5.5 ç§’ï¼‰
  - è¿ç»­æ€§æ˜¯å¦æ–­è£‚ï¼ˆä½ç½®çªå˜ï¼‰
- è‹¥å¤±è´¥ â†’ å±€éƒ¨é‡è¯•ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰

### Step 6ï¼šæ ¼å¼åŒ–è¾“å‡º

- èšåˆæ‰€æœ‰åˆ†é•œ
- è¿”å›æ ‡å‡†åŒ– JSON

```json
{
  "job_id": "shotgen_20251022_cafe_reunion",
  "input_script": "åœºæ™¯ï¼šåŸå¸‚å’–å•¡é¦†ï¼Œä¸‹åˆ3ç‚¹ï¼Œé˜³å…‰å¾ˆå¥½ã€‚\nææ˜ååœ¨é çª—çš„ä½ç½®ï¼Œä½å¤´çœ‹æ‰‹æœºã€‚çªç„¶ï¼Œä»–æŠ¬å¤´çœ‹è§å‰å¥³å‹å°é›¨èµ°è¿›æ¥ï¼Œæ„£ä½äº†ï¼Œæ‰‹æœºå·®ç‚¹æ‰åˆ°åœ°ä¸Šã€‚",
  "style": "realistic",
  "duration_per_shot": 5,
  "total_shots": 2,
  "total_duration_sec": 10,
  "shots": [
    {
      "shot_id": 1,
      "time_range_sec": [0, 5],
      "scene_context": {
        "location": "åŸå¸‚å’–å•¡é¦†å†…",
        "time_of_day": "ä¸‹åˆ3ç‚¹",
        "atmosphere": "é˜³å…‰é€è¿‡è½åœ°çª—ï¼ŒèƒŒæ™¯æœ‰è½»æŸ”çˆµå£«ä¹"
      },
      "characters_in_frame": ["ææ˜"],
      "initial_state": [
        {
          "character_name": "ææ˜",
          "pose": "åå§¿ï¼Œèº«ä½“å¾®å‰å€¾",
          "position": "é çª—ç¬¬äºŒå¼ æ¡Œå­",
          "holding": "æ™ºèƒ½æ‰‹æœº",
          "emotion": "å¹³é™",
          "appearance": "28å²ï¼Œé»‘å‘ï¼Œæˆ´é»‘æ¡†çœ¼é•œï¼Œç©¿ç°è‰²æ¯›è¡£"
        }
      ],
      "action_description": "ææ˜ä¸“æ³¨åœ°çœ‹ç€æ‰‹æœºå±å¹•ï¼Œæ‰‹æŒ‡å¶å°”æ»‘åŠ¨ã€‚",
      "dialogue": "",
      "camera": {
        "shot_type": "medium shot",
        "angle": "eye-level",
        "movement": "static"
      },
      "ai_video_prompt": "A young man with black-rimmed glasses sits alone at a sunlit cafe table, scrolling on his smartphone. Medium shot, natural afternoon light, realistic cinematic style, shallow depth of field, cozy atmosphere.",
      "continuity_anchor": [
        {
          "character_name": "ææ˜",
          "pose": "sitting, looking down at phone",
          "phone_position": "held in both hands, 30cm above wooden table",
          "gaze_direction": "downward",
          "emotion": "calm"
        }
      ]
    },
    {
      "shot_id": 2,
      "time_range_sec": [5, 10],
      "scene_context": {
        "location": "åŸå¸‚å’–å•¡é¦†å†…",
        "time_of_day": "ä¸‹åˆ3ç‚¹",
        "atmosphere": "é˜³å…‰é€è¿‡è½åœ°çª—ï¼ŒèƒŒæ™¯æœ‰è½»æŸ”çˆµå£«ä¹"
      },
      "characters_in_frame": ["ææ˜"],
      "initial_state": [
        {
          "character_name": "ææ˜",
          "pose": "sitting, looking down at phone",
          "position": "é çª—ç¬¬äºŒå¼ æ¡Œå­",
          "holding": "æ™ºèƒ½æ‰‹æœº",
          "emotion": "calm",
          "appearance": "28å²ï¼Œé»‘å‘ï¼Œæˆ´é»‘æ¡†çœ¼é•œï¼Œç©¿ç°è‰²æ¯›è¡£"
        }
      ],
      "action_description": "ææ˜çŒ›ç„¶æŠ¬å¤´çœ‹å‘å’–å•¡é¦†é—¨å£ï¼ŒåŒçœ¼çå¤§ï¼Œæ‰‹æœºä»å·¦æ‰‹æ»‘è½ï¼Œè·ç¦»æ¡Œé¢çº¦10å˜ç±³ã€‚",
      "dialogue": "",
      "camera": {
        "shot_type": "medium close-up",
        "angle": "slightly low angle",
        "movement": "quick focus pull from phone to eyes"
      },
      "ai_video_prompt": "The same man suddenly looks up in shock toward the cafe entrance, his phone slipping from his left hand halfway to the table. Medium close-up, natural lighting, realistic style, subtle camera shake, focus transition from hand to face.",
      "continuity_anchor": [
        {
          "character_name": "ææ˜",
          "pose": "sitting, upper body recoiling slightly backward",
          "phone_position": "falling, 10cm above table",
          "gaze_direction": "toward cafe entrance",
          "emotion": "shock"
        }
      ]
    }
  ],
  "final_continuity_state": [
    {
      "character_name": "ææ˜",
      "pose": "sitting, upper body recoiling slightly backward",
      "phone_position": "falling, 10cm above table",
      "gaze_direction": "toward cafe entrance",
      "emotion": "shock"
    }
  ],
  "metadata": {
    "generated_at": "2025-10-22T14:35:00Z",
    "llm_model": "gpt-4o",
    "continuity_verified": true,
    "version": "1.0"
  }
}
```



## å…³é”®æŠ€æœ¯è®¾è®¡

### 1. **è¿ç»­æ€§ç®¡ç†ï¼ˆæ ¸å¿ƒï¼ï¼‰**

- **çŠ¶æ€ä¼ é€’**ï¼š`continuity_anchor` â†’ `initial_state`
- **è§’è‰²æ³¨å†Œè¡¨**ï¼šé¦–æ¬¡å‡ºç°æ—¶ç”Ÿæˆ appearanceï¼Œåç»­å¼ºåˆ¶å¤ç”¨
- **æ¼‚ç§»æ£€æµ‹**ï¼šè®¡ç®— appearance å‘é‡ç›¸ä¼¼åº¦ï¼ˆ<0.8 åˆ™å‘Šè­¦ï¼‰

### 2. **åŠ¨ä½œæ—¶é•¿ä¼°ç®—**

- **åŠ¨è¯åº“**ï¼š`èµ°: 2.0s`, `èµ·èº«: 1.5s`
- **å¯¹è¯æ¨¡å‹**ï¼š`æ—¶é•¿ = max(å­—æ•°Ã—0.35Ã—æƒ…ç»ªå› å­, 1.5)`
- **è§’è‰²å› å­**ï¼š`elder: Ã—1.3`, `child: Ã—0.85`

### 3. **AI Prompt ç”Ÿæˆ**

- **è‹±æ–‡å¼ºåˆ¶**ï¼šå› ä¸»æµè§†é¢‘æ¨¡å‹ä¾èµ–è‹±æ–‡

- **ç»“æ„åŒ–æ¨¡æ¿**ï¼š

  ```python
  [ä¸»ä½“], [åŠ¨ä½œ], [é•œå¤´], [å…‰çº¿], [é£æ ¼]
  Example: "A man in cafe, looking up in shock, medium close-up, natural lighting, realistic style"
  ```

### 4. **é”™è¯¯æ¢å¤æœºåˆ¶**

- **å±€éƒ¨é‡è¯•**ï¼šä»…é‡ç”Ÿæˆå¤±è´¥åˆ†é•œï¼ˆéå…¨æ–‡é‡è·‘ï¼‰
- **é™çº§ç­–ç•¥**ï¼šQA å¤±è´¥ 2 æ¬¡åï¼Œç®€åŒ–åŠ¨ä½œæè¿°


		

## æŠ€æœ¯å®ç°å»ºè®®

| æ¨¡å—         | æŠ€æœ¯æ–¹æ¡ˆ                                                     |
| ------------ | ------------------------------------------------------------ |
| å·¥ä½œæµç¼–æ’   | é€šè¿‡langchain + langgraph åˆ†é•œç”Ÿæˆå·¥ä½œæµç¼–æ’ï¼Œè´Ÿè´£æ•´ä½“æµç¨‹æ§åˆ¶ï¼Œè°ƒç”¨ LlamaIndexã€LLMã€è§„åˆ™å¼•æ“ç­‰ç»„ä»¶ |
| å‰§æœ¬è§£æ     | LlamaIndex + è‡ªå®šä¹‰å‰§æœ¬è¯­æ³•è§£æå™¨ï¼Œè´Ÿè´£æ·±åº¦ç†è§£åŸå§‹å‰§æœ¬ï¼Œå¹¶æ„å»ºå¯æŸ¥è¯¢çš„ç»“æ„åŒ–çŸ¥è¯†åº“ï¼Œå®ç°æ•°æ®æ£€ç´¢ä¸ç´¢å¼•ä¼˜åŒ– |
| åŠ¨ä½œæ—¶é•¿ä¼°ç®— | åŸºäºåŠ¨ä½œåŠ¨è¯åº“ï¼ˆå¦‚â€œèµ°â€â‰ˆ2ç§’ï¼Œâ€œè¯´ä¸€å¥è¯â€â‰ˆ3ç§’ï¼‰                 |
| è¿ç»­æ€§é”šç‚¹   | å‘é‡è®°å¿†ï¼ˆVector Memoryï¼‰å­˜å‚¨è§’è‰²çŠ¶æ€                        |
| Prompt ç”Ÿæˆ  | LLMï¼ˆå¦‚ GPT-4o / Claude 3.5 / qwen3ï¼‰ + æç¤ºæ¨¡æ¿å¼•æ“         |
| è¾“å‡ºæ ¼å¼     | JSON                                                         |

> æ³¨æ„äº‹é¡¹ï¼š
> 	1ã€ä»…ç”¨ LlamaIndex åšæ£€ç´¢ï¼ŒLangChain ä¸æ„å»ºç‹¬ç«‹å‘é‡åº“
> 	2ã€è¿ç»­æ€§é”šç‚¹ç»Ÿä¸€ç”± LangChain ç®¡ç†
> 	3ã€LlamaIndex ä»…ç”¨äºæ£€ç´¢ï¼Œç”Ÿæˆä»»åŠ¡äº¤ç»™ LangChain çš„ LLM Chain



## è¿›é˜¶åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

â€‹	ğŸ”„ è§’è‰²ä¸€è‡´æ€§IDï¼šä¸ºæ¯ä¸ªè§’è‰²ç”Ÿæˆå›ºå®šå¤–è§‚æè¿°ï¼ˆå¦‚â€œææ˜ï¼šé»‘å‘ï¼Œæˆ´é»‘æ¡†çœ¼é•œï¼Œç©¿ç°è‰²æ¯›è¡£â€ï¼‰ï¼ŒåµŒå…¥æ¯æ®µprompt
â€‹	ğŸï¸ é•œå¤´è¯­è¨€å»ºè®®ï¼šè‡ªåŠ¨æ¨èé•œå¤´ç±»å‹ï¼ˆç‰¹å†™/å…¨æ™¯/è·Ÿæ‹ï¼‰ä»¥å¢å¼ºå™äº‹
â€‹	âš ï¸ ä¸è¿è´¯é¢„è­¦ï¼šæ£€æµ‹æ½œåœ¨è·³åˆ‡ï¼ˆå¦‚è§’è‰²ä½ç½®çªå˜ï¼‰ï¼Œæç¤ºç”¨æˆ·è°ƒæ•´
â€‹	ğŸ–¼ï¸ å‚è€ƒå›¾ç»‘å®šï¼šæ”¯æŒä¸Šä¼ è§’è‰²/åœºæ™¯å‚è€ƒå›¾ï¼Œç”Ÿæˆå¸¦--imageå‚æ•°çš„æç¤ºè¯		
â€‹		